### ========================================
### GATEWAY API TESTS - ALL THROUGH PORT 8083
### ========================================

### ========================================
### 1. AUTHENTICATION (through Gateway)
### ========================================

### Login as ADMIN via Gateway
POST http://localhost:8083/realms/ecommerce/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=product-service&client_secret=5y1n2QKOD9sTqgb9XvSOwCK3upLsqrd6&username=admin&password=admin123

> {% client.global.set("gw_admin_token", response.body.access_token) %}

###

### Login as CLIENT via Gateway
POST http://localhost:8083/realms/ecommerce/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=product-service&client_secret=5y1n2QKOD9sTqgb9XvSOwCK3upLsqrd6&username=client&password=client123

> {% client.global.set("gw_client_token", response.body.access_token) %}

###

### ========================================
### 2. PRODUCT OPERATIONS (through Gateway)
### ========================================

### Create Product via Gateway - ADMIN
POST http://localhost:8083/api/products
Authorization: Bearer {{gw_admin_token}}
Content-Type: application/json

{
  "name": "Laptop Dell XPS 15",
  "description": "High performance laptop with Intel i7, 16GB RAM, 512GB SSD",
  "price": 1299.99,
  "stockQuantity": 50
}

> {% client.global.set("gw_product_id_1", response.body.id) %}

###

### Create Product 2 via Gateway - ADMIN
POST http://localhost:8083/api/products
Authorization: Bearer {{gw_admin_token}}
Content-Type: application/json

{
  "name": "iPhone 15 Pro",
  "description": "Latest Apple smartphone with A17 Pro chip",
  "price": 999.99,
  "stockQuantity": 100
}

> {% client.global.set("gw_product_id_2", response.body.id) %}

###

### Get all products via Gateway
GET http://localhost:8083/api/products
Authorization: Bearer {{gw_client_token}}

###

### Get specific product via Gateway
GET http://localhost:8083/api/products/{{gw_product_id_1}}
Authorization: Bearer {{gw_client_token}}

###

### Update product via Gateway - ADMIN
PUT http://localhost:8083/api/products/{{gw_product_id_1}}
Authorization: Bearer {{gw_admin_token}}
Content-Type: application/json

{
  "name": "Laptop Dell XPS 15 Updated",
  "description": "High performance laptop with extra RAM",
  "price": 1399.99,
  "stockQuantity": 45
}

###

### Delete product via Gateway - ADMIN
DELETE http://localhost:8083/api/products/{{gw_product_id_1}}
Authorization: Bearer {{gw_admin_token}}

###

### ========================================
### 3. ORDER OPERATIONS (through Gateway)
### ========================================

### Create Order via Gateway - CLIENT
POST http://localhost:8083/api/orders
Authorization: Bearer {{gw_client_token}}
Content-Type: application/json

{
  "items": [
    {
      "productId": {{gw_product_id_1}},
      "quantity": 2
    },
    {
      "productId": {{gw_product_id_2}},
      "quantity": 1
    }
  ]
}

> {% client.global.set("gw_order_id_1", response.body.id) %}

###

### Get my orders via Gateway - CLIENT
GET http://localhost:8083/api/orders/my-orders
Authorization: Bearer {{gw_client_token}}

###

### Get specific order via Gateway - CLIENT
GET http://localhost:8083/api/orders/{{gw_order_id_1}}
Authorization: Bearer {{gw_client_token}}

###

### Get all orders via Gateway - ADMIN
GET http://localhost:8083/api/orders
Authorization: Bearer {{gw_admin_token}}

###

### ========================================
### 4. VERIFY DIRECT ACCESS IS BLOCKED
### ========================================

### Try to access Product Service directly (Should FAIL - Connection refused)
GET http://localhost:8081/api/products

###

### Try to access Order Service directly (Should FAIL - Connection refused)
GET http://localhost:8082/api/orders

###

### Try to access Keycloak directly (Should FAIL - Connection refused)
POST http://localhost:8080/realms/ecommerce/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=product-service&client_secret=5y1n2QKOD9sTqgb9XvSOwCK3upLsqrd6&username=admin&password=admin123

###

### ========================================
### 5. HEALTH CHECKS (through Gateway)
### ========================================

### Gateway Health Check
GET http://localhost:8083/actuator/health

###

### Gateway Info
GET http://localhost:8083/actuator/info

###

### Gateway Routes Info
GET http://localhost:8083/actuator/gateway/routes

###

### ========================================
### 6. ERROR SCENARIOS (through Gateway)
### ========================================

### Try without authentication (Should return 401)
GET http://localhost:8083/api/products

###

### Try to create order as ADMIN (Should return 403 - only CLIENT role)
POST http://localhost:8083/api/orders
Authorization: Bearer {{gw_admin_token}}
Content-Type: application/json

{
  "items": [
    {
      "productId": {{gw_product_id_1}},
      "quantity": 1
    }
  ]
}

###

### Try to get all orders as CLIENT (Should return 403 - only ADMIN)
GET http://localhost:8083/api/orders
Authorization: Bearer {{gw_client_token}}

###